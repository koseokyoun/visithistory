<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ë°©ë¬¸í•œ ì¥ì†Œ ì§€ë„</title>
    <style>
        #map { width: 100%; height: 400px; margin-bottom: 20px; }
        .location { border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .location img { max-width: 100%; height: auto; border-radius: 10px; }
    </style>
    <!-- âœ… Kakao Maps SDK -->
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=aa7e1d44f837cbfe9cd3388f9fdfd4bc&libraries=services"></script>
</head>
<body>
<h1>ğŸ“ ë‚´ê°€ ë‹¤ë…€ì˜¨ ì¥ì†Œë“¤</h1>

<!-- âœ… ì§€ë„ ì˜ì—­ ì¶”ê°€ -->
<div id="map"></div>

<!-- âœ… ì¥ì†Œ ëª©ë¡ -->
<div id="locations" th:if="${locations != null}">
    <div th:each="loc : ${locations}" class="location">
        <h2 th:text="${loc.name}">ì¥ì†Œ ì´ë¦„</h2>
        <p><strong>ì£¼ì†Œ:</strong> <span th:text="${loc.address}">ì£¼ì†Œ</span></p>
        <p><strong>ë°©ë¬¸ì¼:</strong> <span th:text="${loc.visitedDate}">ë°©ë¬¸ì¼</span></p>
        <p><strong>ë©”ëª¨:</strong> <span th:text="${loc.memo}">ë©”ëª¨</span></p>
        <img th:if="${loc.imageUrl != null}" th:src="${loc.imageUrl}" th:alt="${loc.name}" />
    </div>
</div>
<div th:if="${locations == null or #lists.isEmpty(locations)}">
    <p>ë“±ë¡ëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
</div>

<!-- íŒì—…ì°½ HTML -->
<div id="form-popup" style="display:none;">
    <div class="popup-content">
        <button class="close-btn" onclick="hideForm()">âœ–</button>
        <h3>ì¥ì†Œ ì…ë ¥</h3>
        <form id="location-form" th:action="@{/locations}" method="post">
            <input type="hidden" name="latitude" th:value="${location?.latitude}" />
            <input type="hidden" name="longitude" th:value="${location?.longitude}" />
            <label>ì¥ì†Œ ì´ë¦„:<br><input type="text" name="name" required /></label><br>
            <label>ì£¼ì†Œ:<br><input type="text" name="address" required /></label><br>
            <label>ë°©ë¬¸ì¼:<br><input type="date" name="visitedDate" required /></label><br>
            <label>ë©”ëª¨:<br><textarea name="memo" rows="3"></textarea></label><br>
            <label>ì´ë¯¸ì§€ URL:<br><input type="text" name="imageUrl" /></label><br><br>
            <button type="submit">ì €ì¥</button>
        </form>
    </div>
</div>

<style>
    #form-popup {
        position: absolute;
        z-index: 9999;
        display: none;
        background-color: rgba(0,0,0,0.5);
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
    }
    .popup-content {
        background: #fff;
        width: 300px;
        margin: 10% auto;
        padding: 20px;
        border-radius: 12px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .popup-content h3 { margin-top: 0; }
    .popup-content label { display: block; margin-bottom: 10px; font-size: 14px; }
    .popup-content input[type="text"],
    .popup-content input[type="date"],
    .popup-content textarea {
        width: 100%;
        padding: 5px;
        box-sizing: border-box;
        margin-top: 4px;
    }
    .popup-content button {
        padding: 8px 14px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }
    .popup-content button:hover { background-color: #45a049; }
    .close-btn {
        position: absolute;
        right: 10px;
        top: 10px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
    }
</style>

<script>
    const mapContainer = document.getElementById('map');
    const mapOption = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì¤‘ì‹¬
        level: 3
    };
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const places = new kakao.maps.services.Places();

    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const latlng = mouseEvent.latLng;
        const lat = latlng.getLat();
        const lng = latlng.getLng();

        const coord = new kakao.maps.LatLng(lat, lng);
        searchDetailAddressFromCoords(coord);
        searchNearbyPlace(coord);

        document.querySelector('input[name="latitude"]').value = lat;
        document.querySelector('input[name="longitude"]').value = lng;

        showForm();
    });

    function searchDetailAddressFromCoords(coords) {
        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.coord2Address(coords.getLng(), coords.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const address = result[0].road_address?.address_name || result[0].address.address_name;
                document.querySelector('input[name="address"]').value = address;
            } else {
                console.warn("ì •í™•í•œ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        });
    }

    function searchNearbyPlace(coords) {
        const options = {
            location: coords,
            radius: 50
        };

        places.keywordSearch('', function(result, status) {
            if (status === kakao.maps.services.Status.OK && result.length > 0) {
                document.querySelector('input[name="name"]').value = result[0].place_name;
            } else {
                console.warn("ì¥ì†Œëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }, options);
    }

    function showForm() {
        document.getElementById('form-popup').style.display = 'block';
    }

    function hideForm() {
        document.getElementById('form-popup').style.display = 'none';
    }

    document.getElementById('location-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const json = {};
        formData.forEach((v, k) => json[k] = v);

        fetch('/locations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(json)
        }).then(res => {
            if (res.ok) {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                hideForm();
                location.reload();
            } else {
                alert('ì €ì¥ ì‹¤íŒ¨');
            }
        });
    });
</script>
</body>
</html>
